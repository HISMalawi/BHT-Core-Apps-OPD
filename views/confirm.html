<script src="/assets/js/jquery.min.js"></script>
<script src="/assets/js/bootstrap/bootstrap.min.js"></script>
<script src="/assets/js/moment.js"></script>


<script src="/assets/js/generic_ajaxrequest.js"></script>
<link rel="stylesheet" href="/assets/css/bootstrap/bootstrap.min.css">
<!-- <rel="stylesheet" href="/assets/css/maindashboard/headefooter.css">  -->
<link rel="stylesheet"  href="/public/touchscreentoolkit/lib/stylesheets/touch-fancy.css" />
<!--ink rel="stylesheet" href="/assets/css/custom.css" /-->
<script src="/assets/js/jquery.min.js"></script>
<script src="/assets/js/moment.js"></script>
<script src="/assets/js/bmi.js"></script>
<script src="/assets/js/bootstrap/bootstrap.min.js"></script>
<script type="text/javascript" src="/assets/js/alertifyjs/alertify.js"></script>
<script
  type="text/javascript"
  src="/assets/js/does_connection_exist.js"
></script>
<script type="text/javascript" src="/assets/js/post_parameters.js"></script>

<script src="/assets/js/httpUtils.js"></script>
<script src="/assets/js/uiUtils.js"></script>
<script src="/assets/js/GlobalProperty.js"></script>

<link
  rel="stylesheet"
  href="/assets/css/alertifyjs/css/alertify.css"
  type="text/css"
/>
<style>
  * {
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
  }

  .demographics-table {
    display: table;
    width: 100%;
    height: 120px;
  }

  .demographics-table-row {
    display: table-row;
  }

  .demographics-table-cell {
    display: table-cell;
    border-style: solid;
    border-width: 1px;
    box-shadow: 5px 10px #888888;
    padding: 20px;
  }

  .info-table {
    display: table;
    width: 100%;
    margin-top: 10px;
    border-collapse: separate;
    border-spacing: 10px;
  }

  .info-table-row {
    display: table-row;
  }

  .info-table-cell {
    display: table-cell;
    border: 1px solid black;
    border-radius: 5px;
    box-shadow: 0 8px 18px 0 rgba(0, 0, 0, 0.2);
    transition: 0.3s;
    height: 230px !important;
    width: 23%;
    display: table-cell;
  }

  .section-badge {
    margin: 10px 10px 5px 10px;
    width: 92%;
    padding-left: 10px;
    background-color: slategray;
    vertical-align: center;
    border-style: solid;
    border-width: 0px 0px 1px 0px;
    color: #fff;
  }

  .section-body {
    margin: 10px 10px 5px 10px;
    width: 92%;
    padding-left: 10px;
    height: 80%;
    background-color: white;
  }

  #demographics-addresses th {
    font-size: 12px;
  }

  .buttonsDIV {
    background-color: #333333;
    display: block;
    height: 80px;
    position: absolute;
    bottom: 1px;
    width: 98.7%;
    z-index: 10;
  }

  /*.buttonsDIV button {
    margin: 5px 0px 0px;
    margin-right: 10px;
    height: 60px;
    font-size: 2rem;
  }

  .blue {
    border: 1px solid #7eb9d0;
    -webkit-border-radius: 3px;
    -moz-border-radius: 3px;
    border-radius: 3px;
    font-size: 28px;
    font-family: helvetica;
    padding: 10px 10px 10px 10px;
    text-decoration: none;
    display: inline-block;
    text-shadow: -1px -1px 0 rgba(0, 0, 0, 0.3);
    font-weight: bold;
    color: #ffffff;
    background-color: #a7cfdf;
    background-image: -webkit-gradient(
      linear,
      left top,
      left bottom,
      from(#a7cfdf),
      to(#23538a)
    );
    background-image: -webkit-linear-gradient(top, #a7cfdf, #23538a);
    background-image: -moz-linear-gradient(top, #a7cfdf, #23538a);
    background-image: -ms-linear-gradient(top, #a7cfdf, #23538a);
    background-image: -o-linear-gradient(top, #a7cfdf, #23538a);
    background-image: linear-gradient(to bottom, #a7cfdf, #23538a);
    filter: progid: DXImageTransform.Microsoft.gradient(GradientType=0, startColorstr=#a7cfdf, endColorstr=#23538a);
  }

  .red {
    border: 1px solid #ff0011;
    background-image: linear-gradient(
      bottom,
      rgb(255, 0, 17) 0%,
      rgb(255, 0, 17) 100%
    );
    background-image: -o-linear-gradient(
      bottom,
      rgb(255, 0, 17) 0%,
      rgb(255, 0, 17) 100%
    );
    background-image: -moz-linear-gradient(
      bottom,
      rgb(255, 0, 17) 0%,
      rgb(255, 0, 17) 100%
    );
    background-image: -webkit-linear-gradient(
      bottom,
      rgb(255, 0, 17) 0%,
      rgb(255, 0, 17) 100%
    );
    background-image: -ms-linear-gradient(
      bottom,
      rgb(255, 0, 17) 0%,
      rgb(255, 0, 17) 100%
    );
    background-image: -webkit-gradient(
      color-stop(0, rgb(255, 0, 17)),
      color-stop(1, rgb(255, 0, 17))
    ) !important;
    background-color: #5c0707;

    border: 1px solid #450111;
    background-color: #77021d;
    background-image: -webkit-gradient(
      linear,
      left top,
      left bottom,
      from(#77021d),
      to(#3a000d)
    );
    background-image: -webkit-linear-gradient(top, #77021d, #3a000d);
    background-image: -moz-linear-gradient(top, #77021d, #3a000d);
    background-image: -ms-linear-gradient(top, #77021d, #3a000d);
    background-image: -o-linear-gradient(top, #77021d, #3a000d);
    background-image: linear-gradient(to bottom, #77021d, #3a000d);
    filter: progid:DXImageTransform.Microsoft.gradient(GradientType=0, startColorstr=#77021d, endColorstr=#3a000d);
    color: #fff;
  }*/

  .info-tables {
    width: 99%;
    border-collapse: collapse;
  }
  td,
  th {
    padding: 3px;
  }
  .info-tables td {
    border-width: 0px 0px 1px 0px;
    border-style: solid;
  }

  #dankPrompt button {
    padding: 1%;
    font-size: 1.3em;
    width: 20%;
    background-color: #303031;
    border-radius: 4px;
  }

/* ... Address cover ............. */
#address-confirmation-table {
  width: 100%;
}

#address-confirmation-table th {
  font-size: 20px;
  font-weight: bold;
  padding-bottom: 40px;
  text-align: center;
}

#address-confirmation-table td {
  border-style: solid;
  border-width: 0px 0px 1px 0px;
}

#address-confirmation {
  display: none;
  background-color: #F4F4F4;
  border: 2px solid #E0E0E0;
  border-radius: 15px;
  height: 75%;
  padding: 5px;
  position: absolute;
  top: 10px;
  width: 97%;
  left: 1%;
  z-index: 991;
}

#address-confirmation-cover {
  display: none;
  position: absolute;
  background-color: black;
  width: 100%;
  height: 102%;
  left: 0%;
  top: 0%;
  z-index: 990;
  opacity: 0.65;
}

#address-confirmation-buttons {
  bottom: 15px;
  width: 99%;
  position: absolute;
}

.address-confirmation-button {
  height: 100px;
  width: 48%;
  font-weight: bold;
  font-size: 15px;
}

#green-btn:hover {
  border: 1px solid #224b09;

  background-color: #36780f;

  background-image: -webkit-gradient(linear, left top, left bottom, from(#36780f), to(#005900));

  background-image: -webkit-linear-gradient(top, #36780f, #005900);

  background-image: -moz-linear-gradient(top, #36780f, #005900);

  background-image: -ms-linear-gradient(top, #36780f, #005900);

  background-image: -o-linear-gradient(top, #36780f, #005900);

  background-image: linear-gradient(to bottom, #36780f, #005900);

  filter: progid:DXImageTransform.Microsoft.gradient(GradientType=0, startColorstr=#36780f, endColorstr=#005900);
  }

#green-btn {
  border: 1px solid #34740e;

  -webkit-border-radius: 3px;

  -moz-border-radius: 3px;

  border-radius: 3px;

  margin-left: 20px;

  font-size: 28px;

  font-family: arial, helvetica, sans-serif;

  padding: 10px 10px 10px 10px;

  text-decoration: none;

  display: inline-block;

  text-shadow: -1px -1px 0 rgba(0, 0, 0, 0.3);

  font-weight: bold;

  color: #FFFFFF;

  background-color: #4ba614;

  background-image: -webkit-gradient(linear, left top, left bottom, from(#4ba614), to(#008c00));

  background-image: -webkit-linear-gradient(top, #4ba614, #008c00);

  background-image: -moz-linear-gradient(top, #4ba614, #008c00);

  background-image: -ms-linear-gradient(top, #4ba614, #008c00);

  background-image: -o-linear-gradient(top, #4ba614, #008c00);

  background-image: linear-gradient(to bottom, #4ba614, #008c00);
  }

#blue-btn:hover {
  border: 1px solid #5ca6c4;

  background-color: #82bbd1;

  background-image: -webkit-gradient(linear, left top, left bottom, from(#82bbd1), to(#193b61));

  background-image: -webkit-linear-gradient(top, #82bbd1, #193b61);

  background-image: -moz-linear-gradient(top, #82bbd1, #193b61);

  background-image: -ms-linear-gradient(top, #82bbd1, #193b61);

  background-image: -o-linear-gradient(top, #82bbd1, #193b61);

  background-image: linear-gradient(to bottom, #82bbd1, #193b61);

  filter: progid:DXImageTransform.Microsoft.gradient(GradientType=0, startColorstr=#82bbd1, endColorstr=#193b61);
  }

#blue-btn {
  border: 1px solid #7eb9d0;

  -webkit-border-radius: 3px;

  -moz-border-radius: 3px;

  border-radius: 3px;

  font-size: 28px;

  font-family: arial, helvetica, sans-serif;

  padding: 10px 10px 10px 10px;

  text-decoration: none;

  display: inline-block;

  text-shadow: -1px -1px 0 rgba(0, 0, 0, 0.3);

  font-weight: bold;

  color: #FFFFFF;

  background-color: #a7cfdf;

  background-image: -webkit-gradient(linear, left top, left bottom, from(#a7cfdf), to(#23538a));

  background-image: -webkit-linear-gradient(top, #a7cfdf, #23538a);

  background-image: -moz-linear-gradient(top, #a7cfdf, #23538a);

  background-image: -ms-linear-gradient(top, #a7cfdf, #23538a);

  background-image: -o-linear-gradient(top, #a7cfdf, #23538a);

  background-image: linear-gradient(to bottom, #a7cfdf, #23538a);

  filter: progid:DXImageTransform.Microsoft.gradient(GradientType=0, startColorstr=#a7cfdf, endColorstr=#23538a);
  }

/* ... Address cover ends ............. */

#nextTask {
  font-size: 12px;
  color: black;
  font-weight: bold;
}

.filing-number-btn {
  position: absolute;
  bottom: 10px;
  right: 10px;
  width: 115px;
}
.high {
  background: red;
}






.list-group-item {
    position: relative;
    display: block;
    padding: 10px 15px;
    margin-bottom: -1px;
    background-color: #fff;
    border: 1px solid #ddd;
}

.list-group-item:first-child {
    border-top-left-radius: 4px;
    border-top-right-radius: 4px;
}

.info-tables a {
  margin: 0px 1px 0px 2px !important;
  text-decoration: none;
  color: black;
}

#deceasesed-message {
  z-index: 1000;
  margin: auto;
  display: inline; 
  height: 30%; 
  width: 50%; 
  left: 30%;
  top: 10%;
}
.ajs-button {
  background: #23538a;
}

.demo-table {
  border-collapse: collapse;
  width: 100%;
}

tr.demo-table {
  text-align: left;
  padding: 8px;
}

</style>

<script>


  var apiPath = `${apiProtocol}://${apiURL}:${apiPort}/api/v1`;
  var patientDead = false;


  function insertData() {
    var url_string = window.location;
    var url = new URL(url_string);
    var patient_id = url.searchParams.get("patient_id");
    var person_id = url.searchParams.get("person_id");
    var person_mnid = url.searchParams.get("person_mnid");
    if (person_id != null) {
      getClientbyID(person_id);
    } else if (patient_id != null) {
      patient_id = patient_id.replace(/-/g, "");
      getClient(patient_id);
    } else if (person_mnid != null) {
      getClientByMNID(person_mnid);
    }
  }

  function getClient(patient_id) {
    var dde_status = "";
    var url = "";
    if (sessionStorage.dde_enabled === "true") {
      url = apiProtocol + "://" + apiURL + ":" + apiPort;
      url += "/api/v1/dde/patients/find_by_npid?npid=" + patient_id;
      url += "&program_id=" + sessionStorage.programID;
    }else {
      url =
      apiProtocol +
      "://" +
      apiURL +
      ":" +
      apiPort +
      "/api/v1/search/patients/by_npid?npid=" +
      patient_id;
    }


    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
      if (this.readyState == 4 && (this.status == 201 || this.status == 200)) {
        if (sessionStorage.dde_enabled === "true") {
          var remotes = JSON.parse(this.responseText)["remotes"];
          var locals = JSON.parse(this.responseText)["locals"];
          if (remotes.length > 1 || locals.length > 1) {
            location.href = "/views/npid_duplicates.html?health_id=" + patient_id;
          }else if (locals.length >= 1 && remotes.length >=1) {
            location.href = "/views/npid_duplicates.html?health_id=" + patient_id;
          } else if (locals.length == 1) {
            populatePatient(locals[0], locals[0]);
          } else {
            noPatient();
          }
        }else {
          var obj = JSON.parse(this.responseText)[0];
          var obj_2 = JSON.parse(this.responseText)[0];
          if (JSON.parse(this.responseText).length > 1) {
            location.href = "/views/duplicates.html?health_id=" + patient_id;
          } else if (JSON.parse(this.responseText).length == 1) {
            populatePatient(obj, obj_2);
          } else {
            noPatient();
          }     
        }
        
      } else if (this.status == 204) {
        window.location.href = "/";
      }else if (this.status == 422) {
        var f = JSON.parse(this.responseText);
        //sessionStorage.patientID = f.patient_id;
        sessionStorage.patientID = f.entity.patient_id;
        window.location.href = "/views/patient/edit_demographics.html";
      }
    };
    xhttp.open("GET", url, true);
    xhttp.setRequestHeader(
      "Authorization",
      sessionStorage.getItem("authorization")
    );
    xhttp.setRequestHeader("Content-type", "application/json");
    xhttp.send();
  }

  function getClientByMNID(patient_id) {
    var dde_status = "";
    var url = "";

      url =
      apiProtocol +
      "://" +
      apiURL +
      ":" +
      apiPort +
      "/api/v1/search/patients/by_identifier?identifier=" +
      patient_id+"&type_id="+28;
    


    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
      if (this.readyState == 4 && (this.status == 201 || this.status == 200)) {
        //console.log("hello: ");
        //console.log(this.responseText);
        if (sessionStorage.dde_enabled === "true") {
          var remotes = JSON.parse(this.responseText)["remotes"];
          var locals = JSON.parse(this.responseText)["locals"];
          if (remotes.length > 1 || locals.length > 1) {
            location.href = "/views/npid_duplicates.html?health_id=" + patient_id;
          }else if (locals.length >= 1 && remotes.length >=1) {
            location.href = "/views/npid_duplicates.html?health_id=" + patient_id;
          } else if (locals.length == 1) {
            populatePatient(locals[0], locals[0]);
          } else {
            noPatient();
          }
        }else {
          var obj = JSON.parse(this.responseText)[0];
          var obj_2 = JSON.parse(this.responseText)[0];
          if (JSON.parse(this.responseText).length > 1) {
            location.href = "/views/duplicates.html?health_id=" + patient_id;
          } else if (JSON.parse(this.responseText).length == 1) {
            populatePatient(obj, obj_2);
          } else {
            noPatient();
          }     
        }
        
      } else if (this.status == 204) {
        window.location.href = "/";
      }else if (this.status == 422) {
        var f = JSON.parse(this.responseText);
        //sessionStorage.patientID = f.patient_id;
        sessionStorage.patientID = f.entity.patient_id;
        window.location.href = "/views/patient/edit_demographics.html";
      }
    };
    xhttp.open("GET", url, true);
    xhttp.setRequestHeader(
      "Authorization",
      sessionStorage.getItem("authorization")
    );
    xhttp.setRequestHeader("Content-type", "application/json");
    xhttp.send();
  }

  function getClientbyID(person_id) {
    var url =
      apiProtocol +
      "://" +
      apiURL +
      ":" +
      apiPort +
      "/api/v1/patients/" +
      person_id;

    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
      if (this.readyState == 4 && (this.status == 201 || this.status == 200)) {
        var obj = JSON.parse(this.responseText);
        var obj_2 = JSON.parse(this.responseText);
        populatePatient(obj, obj_2);
      } else if (this.status == 204) {
        window.location.href = "/";
      }else if (this.status == 422) {
        var f = JSON.parse(this.responseText);
        sessionStorage.patientID = f.patient_id;
        window.location.href = "/views/patient/edit_demographics.html";
      }
    };
    xhttp.open("GET", url, true);
    xhttp.setRequestHeader(
      "Authorization",
      sessionStorage.getItem("authorization")
    );
    xhttp.setRequestHeader("Content-type", "application/json");
    xhttp.send();
  }
  
  function populatePatient(obj, obj_2) {
    var patient = obj;
    obj = obj["person"];
    patient_id = patient["patient_id"];
    sessionStorage.patientID = patient_id;
    checkIfEnrolled(patient_id);
    // checkIfDemographicsUpdated(patient_id);
    var names = obj["names"][0];
  
    sessionStorage.given_name = names["given_name"];
    sessionStorage.family_name = names["family_name"];

    var roundedAge = Math.round(moment().diff(obj["birthdate"], "years", true));
    sessionStorage.patientAge = roundedAge;
    sessionStorage.patientGender = obj["gender"];
    sessionStorage.patientDOB = moment(obj["birthdate"]).format("DD/MMM/YYYY");
    //sessionStorage.sessionDate = moment().format("YYYY-MM-DD");
    getHeight(patient_id);
    getWeight(patient_id);
    sessionStorage.patientID = patient_id;
    

    var gender = null;
    if (sessionStorage.patientGender === "F") {
      gender = "female";
    } else if (sessionStorage.patientGender === "M") {
      gender = "male";
    }
    var bmindex =
      (sessionStorage.currentWeight /
        sessionStorage.currentHeight /
        sessionStorage.currentHeight) *
      10000;
    bmindex = Math.round(bmindex * 10) / 10;
    getBMIResult(gender, roundedAge, bmindex);

    if(sessionStorage.userRoles.match(/Pharmacist/i))
  window.location = '/views/patient/dispensing.html';
else
  nextEncounter(sessionStorage.patientID, sessionStorage.programID);

  
  }

  function getHeight(patient_id) {
    var url = apiProtocol + "://" + apiURL + ":" + apiPort;
    url += "/api/v1/observations?person_id=" + patient_id + "&concept_id=5090";
    url +=
      "&date=" +
      moment(new Date(sessionStorage.sessionDate)).format("YYYY-MM-DD");
    url += "&page_size=1";

    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
      if (this.readyState == 4 && (this.status == 201 || this.status == 200)) {
        var obj = JSON.parse(this.responseText);
        if (obj.length > 0) {
          sessionStorage.currentHeightObsID = obj[0].obs_id;
          var height = parseInt(obj[0].value_numeric);
          if (height > 0) {
            sessionStorage.currentHeight = height;
          } else if (obj[0].value_text.length > 0) {
            sessionStorage.currentHeight = parseInt(obj[0].value_text);
          } else {
            sessionStorage.currentHeight = 0;
          }
        }
      }
    };
    xhttp.open("GET", url, true);
    xhttp.setRequestHeader(
      "Authorization",
      sessionStorage.getItem("authorization")
    );
    xhttp.setRequestHeader("Content-type", "application/json");
    xhttp.send();
  }
  function getWeight(patient_id) {
    var url = apiProtocol + "://" + apiURL + ":" + apiPort;
    url += "/api/v1/observations?person_id=" + patient_id + "&concept_id=5089";
    url +=
      "&date=" +
      moment(new Date(sessionStorage.sessionDate)).format("YYYY-MM-DD");
    url += "&page_size=1";

    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
      if (this.readyState == 4 && (this.status == 201 || this.status == 200)) {
        var obj = JSON.parse(this.responseText);
        if (obj.length > 0) {
          var weight = parseFloat(obj[0].value_numeric);
          if (weight > 0) {
            sessionStorage.currentWeight = weight;
          } else if (obj[0].value_text.length > 0) {
            sessionStorage.currentWeight = parseFloat(obj[0].value_text);
          } else {
            sessionStorage.currentWeight = 0;
          }
        }
      }
    };
    xhttp.open("GET", url, true);
    xhttp.setRequestHeader(
      "Authorization",
      sessionStorage.getItem("authorization")
    );
    xhttp.setRequestHeader("Content-type", "application/json");
    xhttp.send();
  }


  function enrollPatient() {
        // sessionStorage.patientID = person_id;
        var http = new XMLHttpRequest();
        var url = sessionStorage.apiProtocol + '://' + apiURL + ':' + apiPort + '/api/v1/patients/' + sessionStorage.patientID + "/programs/";
        var params = JSON.stringify({
            program_id: sessionStorage.programID,
            date_enrolled: moment(sessionStorage.sessionDate).format("YYYY-MM-DD")
        });
        http.open('POST', url, true);
        //Send the proper header information along with the request
        http.setRequestHeader('Content-type', 'application/json');
        http.onreadystatechange = function () { //Call a function when the state changes.
            if (http.readyState == 4) {
                if (http.status == 201) {
                    var v = JSON.parse(http.responseText);
                } else if (http.status == 409) {
                    alert('Username already exists');
                } else {
                    alert('error' + http.status);
                }
            }
        }
        http.setRequestHeader('Authorization', sessionStorage.getItem('authorization'));
        http.send(params);
  }
  
  insertData();

  function noPatient() {
  
        window.location.href = "/";
  
  }

function checkIfEnrolled(patient_id) {
  
  var url = apiProtocol + "://" + apiURL + ":" + apiPort + "/api/v1/patients/";
  url += sessionStorage.patientID + "/programs";
  let enrolled = false;
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && (this.status == 201 || this.status == 200)) {
      var obj = JSON.parse(this.responseText);
      for (let index = 0; index < obj.length; index++) {
        if(parseInt(obj[index].program.program_id) === parseInt(sessionStorage.programID)) {
          enrolled = true;
          break;
        }
      }
      if (enrolled == false){
          //$("#enroll-program").modal();
          enrollPatient()
      }
    }
  };
  xhttp.open("GET", url, true);
  xhttp.setRequestHeader("Authorization",sessionStorage.getItem("authorization"));
  xhttp.setRequestHeader("Content-type", "application/json");
  xhttp.send();
}







</script>
